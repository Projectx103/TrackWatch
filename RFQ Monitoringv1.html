<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrackWatch RFQ Dashboard Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

// Initialize Supabase
const SUPABASE_URL = 'https://rwlailgtbtbnyjwttxux.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bGFpbGd0YnRibnlqd3R0eHV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjE0NTcsImV4cCI6MjA3NDkzNzQ1N30.sIlyKoGyq05YGcSi9_hyUKN0OImsDL3ujACyGTZRSmY';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
window.supabase = supabase;

const firebaseConfig = {
  apiKey: "AIzaSyD9LCzMuEGIiRQrOVCgH6d-jxxJLZ0QBCk",
  authDomain: "order-monitoring-purchasing.firebaseapp.com",
  projectId: "order-monitoring-purchasing",
  storageBucket: "order-monitoring-purchasing.appspot.com",
  messagingSenderId: "209378598320",
  appId: "1:209378598320:web:0c143d69bc329a994d8a75"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
window.db = db;

let currentUserRole = null;
let allSuppliers = [];
let allRFQs = [];

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("You must be logged in.");
    window.location.href = "login.html";
    return;
  }
  const userSnap = await getDoc(doc(db, "users", user.uid));
  if (!userSnap.exists()) {
    alert("User data not found.");
    window.location.href = "login.html";
    return;
  }
  currentUserRole = userSnap.data().role;
  if (currentUserRole !== "Team Leader") {
    alert("Access denied. Only Team Leaders can access this page.");
    window.location.href = "unauthorized.html";
  }
  loadSuppliers();
  loadRFQMonitoring();
});

window.showSection = (sectionId) => {
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  document.getElementById(sectionId).classList.add('active');
  document.querySelectorAll('aside button').forEach(btn => btn.classList.remove('active'));
  const targetBtn = document.querySelector(`aside button[data-target="${sectionId}"]`);
  if (targetBtn) targetBtn.classList.add('active');
};

window.addRow = () => {
  const tbody = document.getElementById('rfqBody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" class="input-field item-name" placeholder="Item Name"></td>
    <td><input type="text" class="input-field part-no" placeholder="Part No."></td>
    <td><input type="number" class="input-field quantity" placeholder="Qty"></td>
    <td><input type="text" class="input-field maker" placeholder="Maker"></td>
    <td><button class="remove-btn" onclick="removeRow(this)">Remove</button></td>
  `;
  tbody.appendChild(row);
};

window.removeRow = (btn) => btn.closest('tr').remove();

window.saveRFQ = async () => {
  if (currentUserRole !== "Team Leader") {
    alert("You do not have permission to save RFQs.");
    return;
  }
  const rfqNumber = document.getElementById('rfqNumber').value.trim();
  const rfqDescription = document.getElementById('rfqDescription').value.trim();
  
  if (!rfqNumber) return alert('RFQ Number is required.');

  const rows = document.querySelectorAll('#rfqBody tr');
  const items = [];
  rows.forEach(row => {
    const itemName = row.querySelector('.item-name').value.trim();
    const partNo = row.querySelector('.part-no').value.trim();
    const quantity = row.querySelector('.quantity').value.trim();
    const maker = row.querySelector('.maker').value.trim();
    if(itemName && partNo && quantity) {
      items.push({ itemName, partNo, quantity, maker });
    }
  });

  if(items.length === 0) return alert('Fill at least one row.');

  try {
    await addDoc(collection(db, 'rfqs'), {
      rfqNumber,
      description: rfqDescription,
      createdAt: new Date(),
      status: 'Open',
      items,
      suppliers: []
    });
    alert('RFQ saved successfully!');
    document.getElementById('rfqBody').innerHTML = '';
    document.getElementById('rfqNumber').value = '';
    document.getElementById('rfqDescription').value = '';
    loadRFQMonitoring();
  } catch (err) {
    console.error(err);
    alert('Error saving RFQ: ' + err.message);
  }
};

window.addSupplier = async () => {
  const name = document.getElementById('supplierName').value.trim();
  const contact = document.getElementById('supplierContact').value.trim();
  const email = document.getElementById('supplierEmail').value.trim();
  const address = document.getElementById('supplierAddress').value.trim();
  const paymentTerm = document.getElementById('supplierPaymentTerm').value.trim();
  const currency = document.getElementById('supplierCurrency').value;
  const courier = document.getElementById('supplierCourier').value;

  if (!name || !email) return alert('Supplier name and email are required.');

  try {
    await addDoc(collection(db, 'suppliers'), {
  name,
  contact,
  email,
  address,
  paymentTerm,
  currency,
  courier,
  createdAt: new Date()
});
    alert('Supplier added successfully!');
    document.getElementById('supplierName').value = '';
    document.getElementById('supplierContact').value = '';
    document.getElementById('supplierEmail').value = '';
    document.getElementById('supplierAddress').value = '';
    document.getElementById('supplierPaymentTerm').value = '';
    document.getElementById('supplierCurrency').value = 'PHP';
    document.getElementById('supplierCourier').value = '';

    loadSuppliers();
  } catch (err) {
    console.error(err);
    alert('Error adding supplier: ' + err.message);
  }
};

async function loadSuppliers() {
  allSuppliers = [];
  const tbody = document.getElementById('supplierListBody');
  tbody.innerHTML = '';
  try {
    const querySnapshot = await getDocs(collection(db, 'suppliers'));
    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      allSuppliers.push({ id: docSnap.id, ...data });
const tr = document.createElement('tr');
tr.innerHTML = `
  <td><a href="#" class="supplier-link" onclick="event.preventDefault(); editSupplier('${docSnap.id}')">${data.name || 'N/A'}</a></td>
  <td>${data.contact || 'N/A'}</td>
  <td>${data.email || 'N/A'}</td>
  <td>${data.address || 'N/A'}</td>
  <td>${data.paymentTerm || 'N/A'}</td>
  <td><span class="currency-badge currency-${data.currency || 'PHP'}">${data.currency || 'PHP'}</span></td>
  <td>${data.courier || 'N/A'}</td>
`;
      tbody.appendChild(tr);
    });
  } catch(err) {
    console.error(err);
  }
}

window.editSupplier = async (supplierId) => {
  const supplier = allSuppliers.find(s => s.id === supplierId);
  if (!supplier) return;

  document.getElementById('supplierName').value = supplier.name || '';
  document.getElementById('supplierContact').value = supplier.contact || '';
  document.getElementById('supplierEmail').value = supplier.email || '';
  document.getElementById('supplierAddress').value = supplier.address || '';
  document.getElementById('supplierPaymentTerm').value = supplier.paymentTerm || '';
  document.getElementById('supplierCurrency').value = supplier.currency || 'PHP';
  document.getElementById('supplierCourier').value = supplier.courier || '';
  document.getElementById('currentEditSupplierId').value = supplierId;

  const saveBtn = document.querySelector('#supplierSection .save-btn');
  saveBtn.textContent = 'Update Supplier';
  saveBtn.onclick = updateSupplier;

  let cancelBtn = document.getElementById('cancelSupplierEdit');
  if (!cancelBtn) {
    cancelBtn = document.createElement('button');
    cancelBtn.id = 'cancelSupplierEdit';
    cancelBtn.className = 'action-btn secondary';
    cancelBtn.textContent = 'Cancel Edit';
    cancelBtn.onclick = cancelSupplierEdit;
    saveBtn.parentElement.insertBefore(cancelBtn, saveBtn);
  }

  document.getElementById('supplierName').scrollIntoView({ behavior: 'smooth', block: 'start' });
};

window.updateSupplier = async () => {
  const supplierId = document.getElementById('currentEditSupplierId').value;
  if (!supplierId) return;

  const name = document.getElementById('supplierName').value.trim();
  const contact = document.getElementById('supplierContact').value.trim();
  const email = document.getElementById('supplierEmail').value.trim();
  const address = document.getElementById('supplierAddress').value.trim();
  const paymentTerm = document.getElementById('supplierPaymentTerm').value.trim();
  const currency = document.getElementById('supplierCurrency').value;
  const courier = document.getElementById('supplierCourier').value;
  
  if (!name || !email) return alert('Supplier name and email are required.');

  try {
    await updateDoc(doc(db, 'suppliers', supplierId), {
  name,
  contact,
  email,
  address,
  paymentTerm,
  currency,
  courier
});
    alert('Supplier updated successfully!');
    cancelSupplierEdit();
    loadSuppliers();
  } catch (err) {
    console.error(err);
    alert('Error updating supplier: ' + err.message);
  }
};

window.cancelSupplierEdit = () => {
  document.getElementById('supplierName').value = '';
  document.getElementById('supplierContact').value = '';
  document.getElementById('supplierEmail').value = '';
  document.getElementById('supplierAddress').value = '';
  document.getElementById('supplierPaymentTerm').value = '';
  document.getElementById('supplierCurrency').value = 'PHP';
  document.getElementById('supplierCourier').value = '';
  document.getElementById('currentEditSupplierId').value = '';

  const saveBtn = document.querySelector('#supplierSection .save-btn');
  saveBtn.textContent = 'Add Supplier';
  saveBtn.onclick = addSupplier;

  const cancelBtn = document.getElementById('cancelSupplierEdit');
  if (cancelBtn) cancelBtn.remove();
};

async function loadRFQMonitoring() {
  allRFQs = [];
  const tbody = document.getElementById('rfqMonitoringBody');
  tbody.innerHTML = '';
  try {
    const q = query(collection(db, 'rfqs'), orderBy('createdAt', 'desc'));
    const querySnapshot = await getDocs(q);
    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      allRFQs.push({ id: docSnap.id, ...data });
      const tr = document.createElement('tr');
      const statusClass = data.status === 'Open' ? 'status-open' : 'status-closed';
      const supplierCount = data.suppliers ? data.suppliers.length : 0;
      tr.innerHTML = `
        <td><a href="#" class="rfq-link" onclick="event.preventDefault(); viewRFQDetails('${docSnap.id}')">${data.rfqNumber || 'N/A'}</a></td>
        <td>${data.description || ''}</td>
        <td>${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : ''}</td>
        <td><span class="status-badge ${statusClass}">${data.status || 'Open'}</span></td>
        <td>${supplierCount}</td>
        <td>
          ${data.status === 'Closed' ? 
            `<button class="action-btn primary" onclick="openPriceComparison('${docSnap.id}')">Price Comparison</button>` :
            `<button class="action-btn" onclick="viewRFQDetails('${docSnap.id}')">View Details</button>
             <button class="action-btn secondary" onclick="manageSuppliers('${docSnap.id}')">Manage Suppliers</button>`
          }
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch(err) {
    console.error(err);
  }
}

window.viewRFQDetails = async (rfqId) => {
  const rfq = allRFQs.find(r => r.id === rfqId);
  if (!rfq) return;

  document.getElementById('currentRFQId').value = rfqId;
  const modal = document.getElementById('rfqDetailsModal');
  document.getElementById('detailRFQNumber').textContent = rfq.rfqNumber;
  document.getElementById('detailRFQDescription').textContent = rfq.description || 'N/A';
  document.getElementById('detailRFQDate').textContent = rfq.createdAt ? new Date(rfq.createdAt.seconds * 1000).toLocaleString() : 'N/A';
  document.getElementById('detailRFQStatus').textContent = rfq.status || 'Open';
  
  const itemsBody = document.getElementById('rfqItemsBody');
  itemsBody.innerHTML = '';
  if (rfq.items && rfq.items.length > 0) {
    rfq.items.forEach((item, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${item.itemName}</td>
        <td>${item.partNo}</td>
        <td>${item.quantity}</td>
        <td>${item.maker || 'N/A'}</td>
      `;
      itemsBody.appendChild(tr);
    });
  }

  const suppliersBody = document.getElementById('rfqSuppliersBody');
  suppliersBody.innerHTML = '';
  if (rfq.suppliers && rfq.suppliers.length > 0) {
    rfq.suppliers.forEach(sup => {
      const tr = document.createElement('tr');
      const statusClass = `status-${sup.status.toLowerCase().replace(/\s/g, '-')}`;
      tr.innerHTML = `
        <td>${sup.name}</td>
        <td>${sup.sentDate || 'N/A'}</td>
        <td><span class="status-badge ${statusClass}">${sup.status}</span></td>
        <td>${sup.responseDate || '-'}</td>
        <td>${sup.notes || '-'}</td>
      `;
      suppliersBody.appendChild(tr);
    });
  } else {
    suppliersBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No suppliers assigned yet</td></tr>';
  }

  modal.style.display = 'flex';
};

window.closeRFQDetailsModal = () => {
  document.getElementById('rfqDetailsModal').style.display = 'none';
};

window.manageSuppliers = async (rfqId) => {
  const rfq = allRFQs.find(r => r.id === rfqId);
  if (!rfq) return;

  document.getElementById('supplierRFQNumber').textContent = rfq.rfqNumber;
  document.getElementById('currentRFQIdSupplier').value = rfqId;

  const supplierChecklist = document.getElementById('supplierChecklist');
  supplierChecklist.innerHTML = '';
  
  const existingSuppliers = rfq.suppliers || [];
  
  allSuppliers.forEach(supplier => {
    const existing = existingSuppliers.find(s => s.id === supplier.id);
    const div = document.createElement('div');
    div.className = 'supplier-check-item';
    div.innerHTML = `
      <label>
        <input type="checkbox" value="${supplier.id}" ${existing ? 'checked' : ''} onchange="toggleSupplierDetails(this, '${supplier.id}')">
        <span>${supplier.name} (${supplier.email}) - Payment: ${supplier.paymentTerm || 'N/A'} - Currency: ${supplier.currency || 'PHP'}</span>
      </label>
      <div class="supplier-details" id="details-${supplier.id}" style="display:${existing ? 'block' : 'none'}">
        <div class="form-row">
          <div class="form-group">
            <label>Sent Date:</label>
            <input type="date" class="input-field" id="sent-${supplier.id}" value="${existing ? existing.sentDate : new Date().toISOString().split('T')[0]}">
          </div>
          <div class="form-group">
            <label>Status:</label>
            <select class="input-field" id="status-${supplier.id}">
              <option value="Pending Response" ${existing && existing.status === 'Pending Response' ? 'selected' : ''}>Pending Response</option>
              <option value="Responded" ${existing && existing.status === 'Responded' ? 'selected' : ''}>Responded</option>
              <option value="Quote Received" ${existing && existing.status === 'Quote Received' ? 'selected' : ''}>Quote Received</option>
              <option value="Declined" ${existing && existing.status === 'Declined' ? 'selected' : ''}>Declined</option>
              <option value="Follow-up Required" ${existing && existing.status === 'Follow-up Required' ? 'selected' : ''}>Follow-up Required</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Response Date (Optional):</label>
          <input type="date" class="input-field" id="response-${supplier.id}" value="${existing && existing.responseDate ? existing.responseDate : ''}">
        </div>
        <div class="form-group">
          <label>Notes:</label>
          <textarea class="input-field" id="notes-${supplier.id}" rows="2">${existing ? existing.notes || '' : ''}</textarea>
        </div>
      </div>
    `;
    supplierChecklist.appendChild(div);
  });

  document.getElementById('supplierManagementModal').style.display = 'flex';
};

window.toggleSupplierDetails = (checkbox, supplierId) => {
  const details = document.getElementById(`details-${supplierId}`);
  details.style.display = checkbox.checked ? 'block' : 'none';
};

window.saveSupplierAssignments = async () => {
  const rfqId = document.getElementById('currentRFQIdSupplier').value;
  const checkboxes = document.querySelectorAll('#supplierChecklist input[type="checkbox"]');
  const selectedSuppliers = [];

  checkboxes.forEach(checkbox => {
    if (checkbox.checked) {
      const supplierId = checkbox.value;
      const supplier = allSuppliers.find(s => s.id === supplierId);
      if (supplier) {
        selectedSuppliers.push({
          id: supplierId,
          name: supplier.name,
          email: supplier.email,
          paymentTerm: supplier.paymentTerm || 'N/A',
          currency: supplier.currency || 'PHP',
          sentDate: document.getElementById(`sent-${supplierId}`).value,
          status: document.getElementById(`status-${supplierId}`).value,
          responseDate: document.getElementById(`response-${supplierId}`).value,
          notes: document.getElementById(`notes-${supplierId}`).value
        });
      }
    }
  });

  try {
    await updateDoc(doc(db, 'rfqs', rfqId), {
      suppliers: selectedSuppliers
    });
    alert('Supplier assignments saved successfully!');
    closeSupplierManagementModal();
    loadRFQMonitoring();
  } catch (err) {
    console.error(err);
    alert('Error saving suppliers: ' + err.message);
  }
};

window.closeSupplierManagementModal = () => {
  document.getElementById('supplierManagementModal').style.display = 'none';
};

window.updateRFQStatus = async (newStatus) => {
  const rfqId = document.getElementById('currentRFQId').value;
  try {
    await updateDoc(doc(db, 'rfqs', rfqId), {
      status: newStatus
    });
    alert('RFQ status updated to ' + newStatus + '!');
    loadRFQMonitoring();
    closeRFQDetailsModal();
  } catch (err) {
    console.error(err);
    alert('Error updating status: ' + err.message);
  }
};

// Upload PDF file to Supabase
window.uploadSupplierQuote = async (supplierId, fileInput) => {
  const file = fileInput.files[0];
  if (!file) {
    alert('Please select a file first');
    return;
  }

  if (file.type !== 'application/pdf') {
    alert('Please upload a PDF file only');
    fileInput.value = '';
    return;
  }

  const rfqId = document.getElementById('comparisonRFQId').value;
  const rfq = allRFQs.find(r => r.id === rfqId);
  
  const uploadBtn = fileInput.nextElementSibling;
  const originalText = uploadBtn.textContent;
  uploadBtn.textContent = 'Uploading...';
  uploadBtn.disabled = true;

  try {
    const fileName = `${rfqId}_${supplierId}_${Date.now()}_${file.name}`;
    const filePath = `quotations/${fileName}`;

    const { data, error } = await supabase.storage
      .from('rfq-documents')
      .upload(filePath, file, {
        cacheControl: '3600',
        upsert: false
      });

    if (error) throw error;

    const { data: urlData } = supabase.storage
      .from('rfq-documents')
      .getPublicUrl(filePath);

    const uploadedFiles = rfq.uploadedQuotes || {};
    if (!uploadedFiles[supplierId]) {
      uploadedFiles[supplierId] = [];
    }
    
    uploadedFiles[supplierId].push({
      fileName: file.name,
      filePath: filePath,
      fileUrl: urlData.publicUrl,
      uploadedAt: new Date().toISOString()
    });

    await updateDoc(doc(db, 'rfqs', rfqId), {
      uploadedQuotes: uploadedFiles
    });

    const rfqIndex = allRFQs.findIndex(r => r.id === rfqId);
    if (rfqIndex !== -1) {
      allRFQs[rfqIndex].uploadedQuotes = uploadedFiles;
    }

    alert('File uploaded successfully!');
    fileInput.value = '';
    
    openPriceComparison(rfqId);
    
  } catch (err) {
    console.error('Upload error:', err);
    alert('Error uploading file: ' + err.message);
  } finally {
    uploadBtn.textContent = originalText;
    uploadBtn.disabled = false;
  }
};

// Delete uploaded file
window.deleteUploadedQuote = async (supplierId, fileIndex) => {
  if (!confirm('Are you sure you want to delete this file?')) return;

  const rfqId = document.getElementById('comparisonRFQId').value;
  const rfq = allRFQs.find(r => r.id === rfqId);
  
  try {
    const uploadedFiles = rfq.uploadedQuotes || {};
    const fileToDelete = uploadedFiles[supplierId][fileIndex];
    
    const { error } = await supabase.storage
      .from('rfq-documents')
      .remove([fileToDelete.filePath]);

    if (error) throw error;

    uploadedFiles[supplierId].splice(fileIndex, 1);
    
    if (uploadedFiles[supplierId].length === 0) {
      delete uploadedFiles[supplierId];
    }

    await updateDoc(doc(db, 'rfqs', rfqId), {
      uploadedQuotes: uploadedFiles
    });

    const rfqIndex = allRFQs.findIndex(r => r.id === rfqId);
    if (rfqIndex !== -1) {
      allRFQs[rfqIndex].uploadedQuotes = uploadedFiles;
    }

    alert('File deleted successfully!');
    openPriceComparison(rfqId);
    
  } catch (err) {
    console.error('Delete error:', err);
    alert('Error deleting file: ' + err.message);
  }
};

window.openPriceComparison = async (rfqId) => {
  const rfq = allRFQs.find(r => r.id === rfqId);
  if (!rfq) return;

  document.getElementById('comparisonRFQId').value = rfqId;
  document.getElementById('comparisonRFQNumber').textContent = rfq.rfqNumber;
  
  const tbody = document.getElementById('priceComparisonBody');
  tbody.innerHTML = '';
  
  if (!rfq.items || rfq.items.length === 0) {
    tbody.innerHTML = '<tr><td colspan="100%" style="text-align:center;">No items found</td></tr>';
    document.getElementById('priceComparisonModal').style.display = 'flex';
    return;
  }

  const respondedSuppliers = (rfq.suppliers || []).filter(s => 
    s.status === 'Responded' || s.status === 'Quote Received'
  );

  if (respondedSuppliers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="100%" style="text-align:center;">No suppliers have responded yet</td></tr>';
    document.getElementById('priceComparisonHead').innerHTML = '<tr><th>NO.</th><th>ITEM DESCRIPTION</th><th>MESSAGE</th></tr>';
    document.getElementById('exchangeRateSection').style.display = 'none';
    document.getElementById('priceComparisonModal').style.display = 'flex';
    return;
  }

  const currencies = new Set(respondedSuppliers.map(s => s.currency || 'PHP'));
  const hasMixedCurrency = currencies.size > 1 || !currencies.has('PHP');
  
  const exchangeSection = document.getElementById('exchangeRateSection');
  if (hasMixedCurrency) {
    exchangeSection.style.display = 'block';
    
    const existingRates = rfq.exchangeRates || {};
    document.getElementById('exchangeRateUSD').value = existingRates.USD || '';
    document.getElementById('exchangeRateJPY').value = existingRates.JPY || '';
  } else {
    exchangeSection.style.display = 'none';
  }

  const existingData = rfq.priceComparison || {};
  const uploadedQuotes = rfq.uploadedQuotes || {};

  rfq.items.forEach((item, idx) => {
    respondedSuppliers.forEach((supplier, supIdx) => {
      const tr = document.createElement('tr');
      
      const savedData = existingData[`${idx}_${supplier.id}`] || {};
      
      let cellsHTML = '';
      
      if (supIdx === 0) {
        cellsHTML += `
          <td rowspan="${respondedSuppliers.length}" class="row-number">${idx + 1}</td>
          <td rowspan="${respondedSuppliers.length}" class="item-desc">
            <strong>${item.itemName}</strong>
            ${item.partNo ? `<br><span class="part-no">${item.partNo}</span>` : ''}
          </td>
        `;
      }
      
      const supplierCurrency = supplier.currency || 'PHP';
      
      cellsHTML += `
        <td class="supplier-col">
          <div style="margin-bottom: 8px; font-weight: 600;">${supplier.name}</div>
          <div style="margin-top: 8px;">
            <input type="file" id="file-${idx}-${supplier.id}" accept=".pdf" style="display:none;">
            <button class="action-btn secondary" style="font-size: 11px; padding: 4px 8px;" onclick="document.getElementById('file-${idx}-${supplier.id}').click(); document.getElementById('file-${idx}-${supplier.id}').onchange = function() { uploadSupplierQuote('${supplier.id}', this); };">Upload Quote</button>
          </div>
          ${uploadedQuotes[supplier.id] && uploadedQuotes[supplier.id].length > 0 ? `
            <div style="margin-top: 8px; font-size: 11px;">
              ${uploadedQuotes[supplier.id].map((file, fileIdx) => `
                <div style="background: #e6ffe6; padding: 4px 6px; margin: 2px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                  <a href="${file.fileUrl}" target="_blank" style="color: #006400; text-decoration: none; flex: 1; overflow: hidden; text-overflow:ellipsis; white-space: nowrap;">${file.fileName}</a>
                  <button onclick="deleteUploadedQuote('${supplier.id}', ${fileIdx})" style="background: #ff4444; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 10px; margin-left: 4px;">Ã—</button>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </td>
        <td class="uom-col"><input type="text" class="input-field compact" placeholder="PCS" value="${savedData.uom || 'PCS'}" data-uom="${idx}" data-supplier="${supplier.id}"></td>
        <td class="currency-col"><span class="currency-badge currency-${supplierCurrency}">${supplierCurrency}</span></td>
        <td class="price-col"><input type="text" class="input-field compact price-input" placeholder="0.00" value="${savedData.price || ''}" data-item="${idx}" data-supplier="${supplier.id}" onchange="calculatePHPPrice(${idx}, '${supplier.id}', '${supplierCurrency}')"></td>
        <td class="php-price-col"><span id="php-price-${idx}-${supplier.id}" class="php-price-display">${savedData.phpPrice || '-'}</span></td>
        <td><input type="text" class="input-field compact" placeholder="Lead Time" value="${savedData.leadTime || ''}" data-leadtime="${idx}" data-supplier="${supplier.id}"></td>
        <td><input type="text" class="input-field compact" placeholder="Payment Term" value="${savedData.paymentTerm || supplier.paymentTerm || ''}" data-payment="${idx}" data-supplier="${supplier.id}"></td>
        <td><input type="text" class="input-field compact" placeholder="Remarks" value="${savedData.remarks || ''}" data-remarks="${idx}" data-supplier="${supplier.id}"></td>
      `;
      
      tr.innerHTML = cellsHTML;
      tbody.appendChild(tr);
    });
  });

  const thead = document.getElementById('priceComparisonHead');
  thead.innerHTML = `
    <tr>
      <th style="width: 3%;">NO.</th>
      <th style="width: 16%;">ITEM DESCRIPTION</th>
      <th style="width: 11%;">SUPPLIER</th>
      <th style="width: 5%;">UOM</th>
      <th style="width: 5%;">CURRENCY</th>
      <th style="width: 9%;">COST/PRICE</th>
      <th style="width: 10%;">PHP COST/PRICE</th>
      <th style="width: 9%;">LEAD TIME</th>
      <th style="width: 14%;">PAYMENT TERM</th>
      <th style="width: 18%;">REMARKS</th>
    </tr>
  `;
  document.getElementById('priceComparisonModal').style.display = 'flex';
};

window.calculatePHPPrice = (itemIdx, supplierId, currency) => {
  const priceInput = document.querySelector(`input[data-item="${itemIdx}"][data-supplier="${supplierId}"]`);
  const phpPriceDisplay = document.getElementById(`php-price-${itemIdx}-${supplierId}`);
  
  if (!priceInput || !phpPriceDisplay) return;
  
  const price = parseFloat(priceInput.value);
  if (isNaN(price) || price <= 0) {
    phpPriceDisplay.textContent = '-';
    return;
  }
  
  if (currency === 'PHP') {
    phpPriceDisplay.textContent = price.toFixed(2);
    return;
  }
  
  const usdRate = document.getElementById('exchangeRateUSD').value;
  const jpyRate = document.getElementById('exchangeRateJPY').value;
  
  let phpPrice = 0;
  
  if (currency === 'USD' && usdRate) {
    phpPrice = price * parseFloat(usdRate);
  } else if (currency === 'JPY' && jpyRate) {
    phpPrice = price * parseFloat(jpyRate);
  } else {
    phpPriceDisplay.textContent = 'Set Rate';
    return;
  }
  
  phpPriceDisplay.textContent = phpPrice.toFixed(2);
};

window.recalculateAllPHPPrices = () => {
  const rfqId = document.getElementById('comparisonRFQId').value;
  const rfq = allRFQs.find(r => r.id === rfqId);
  if (!rfq) return;

  const respondedSuppliers = (rfq.suppliers || []).filter(s => 
    s.status === 'Responded' || s.status === 'Quote Received'
  );

  rfq.items.forEach((item, idx) => {
    respondedSuppliers.forEach(supplier => {
      const currency = supplier.currency || 'PHP';
      calculatePHPPrice(idx, supplier.id, currency);
    });
  });
};

window.closePriceComparisonModal = () => {
  document.getElementById('priceComparisonModal').style.display = 'none';
};

window.openSignatoryModal = () => {
  const rfqId = document.getElementById('comparisonRFQId').value;
  const rfq = allRFQs.find(r => r.id === rfqId);
  
  if (rfq && rfq.signatories) {
    document.getElementById('signatoryCount').value = rfq.signatories.length;
  }
  
  generateSignatoryFields();
  document.getElementById('signatoryModal').style.display = 'flex';
};

window.closeSignatoryModal = () => {
  document.getElementById('signatoryModal').style.display = 'none';
};

window.generateSignatoryFields = () => {
  const count = parseInt(document.getElementById('signatoryCount').value) || 5;
  const container = document.getElementById('signatoryFieldsContainer');
  container.innerHTML = '';
  
  const rfqId = document.getElementById('comparisonRFQId').value;
  const rfq = allRFQs.find(r => r.id === rfqId);
  const existingSignatories = rfq && rfq.signatories ? rfq.signatories : [];
  
  for (let i = 0; i < count; i++) {
    const existing = existingSignatories[i] || {};
    const div = document.createElement('div');
    div.className = 'signatory-item';
    div.innerHTML = `
      <h4 style="margin-bottom: 12px; color: var(--text-primary); font-size: 14px;">Signatory ${i + 1}</h4>
      <div class="form-row">
        <div class="form-group">
          <label>Box Header (Top):</label>
          <input type="text" class="input-field signatory-header" placeholder="e.g., Approved by" value="${existing.header || ''}">
        </div>
        <div class="form-group">
          <label>Name/Title (Bottom):</label>
          <input type="text" class="input-field signatory-title" placeholder="e.g., Purch.S.V" value="${existing.title || ''}">
        </div>
      </div>
    `;
    container.appendChild(div);
  }
};

window.saveSignatories = async () => {
  const rfqId = document.getElementById('comparisonRFQId').value;
  const signatoryItems = document.querySelectorAll('.signatory-item');
  const signatories = [];
  
  signatoryItems.forEach((item, idx) => {
    const header = item.querySelector('.signatory-header').value.trim();
    const title = item.querySelector('.signatory-title').value.trim();
    
    signatories.push({
      header: header || `Signatory ${idx + 1}`,
      title: title || ''
    });
  });
  
  try {
    await updateDoc(doc(db, 'rfqs', rfqId), {
      signatories: signatories
    });
    
    const rfqIndex = allRFQs.findIndex(r => r.id === rfqId);
    if (rfqIndex !== -1) {
      allRFQs[rfqIndex].signatories = signatories;
    }
    
    alert('Signatories saved successfully!');
    closeSignatoryModal();
  } catch (err) {
    console.error(err);
    alert('Error saving signatories: ' + err.message);
  }
};

window.savePriceComparisonData = async () => {
  const rfqId = document.getElementById('comparisonRFQId').value;
  const rfqIndex = allRFQs.findIndex(r => r.id === rfqId);
  if (rfqIndex === -1) return;

  const rfq = allRFQs[rfqIndex];
  const respondedSuppliers = (rfq.suppliers || []).filter(s => 
    s.status === 'Responded' || s.status === 'Quote Received'
  );

  const priceComparison = {};
  
  rfq.items.forEach((item, idx) => {
    respondedSuppliers.forEach(supplier => {
      const uomInput = document.querySelector(`input[data-uom="${idx}"][data-supplier="${supplier.id}"]`);
      const priceInput = document.querySelector(`input[data-item="${idx}"][data-supplier="${supplier.id}"]`);
      const leadTimeInput = document.querySelector(`input[data-leadtime="${idx}"][data-supplier="${supplier.id}"]`);
      const paymentInput = document.querySelector(`input[data-payment="${idx}"][data-supplier="${supplier.id}"]`);
      const remarksInput = document.querySelector(`input[data-remarks="${idx}"][data-supplier="${supplier.id}"]`);
      
     priceComparison[`${idx}_${supplier.id}`] = {
        uom: uomInput ? uomInput.value : 'PCS',
        price: priceInput ? priceInput.value : '',
        phpPrice: document.getElementById(`php-price-${idx}-${supplier.id}`) ? document.getElementById(`php-price-${idx}-${supplier.id}`).textContent : '',
        leadTime: leadTimeInput ? leadTimeInput.value : '',
        paymentTerm: paymentInput ? paymentInput.value : '',
        remarks: remarksInput ? remarksInput.value : ''
      };
    });
  });

  const exchangeRates = {};
  const exchangeSection = document.getElementById('exchangeRateSection');
  if (exchangeSection.style.display !== 'none') {
    const usdRate = document.getElementById('exchangeRateUSD').value.trim();
    const jpyRate = document.getElementById('exchangeRateJPY').value.trim();
    if (usdRate) exchangeRates.USD = usdRate;
    if (jpyRate) exchangeRates.JPY = jpyRate;
  }

  try {
    await updateDoc(doc(db, 'rfqs', rfqId), {
      priceComparison: priceComparison,
      exchangeRates: exchangeRates
    });

    allRFQs[rfqIndex].priceComparison = priceComparison;
    allRFQs[rfqIndex].exchangeRates = exchangeRates;

    alert('Price comparison data saved successfully!');
  } catch (err) {
    console.error(err);
    alert('Error saving price comparison: ' + err.message);
  }
};

window.generatePreview = () => {
  const rfqId = document.getElementById('comparisonRFQId').value;
  const rfq = allRFQs.find(r => r.id === rfqId);
  if (!rfq) return;

  const respondedSuppliers = (rfq.suppliers || []).filter(s => 
    s.status === 'Responded' || s.status === 'Quote Received'
  );

  const exchangeRates = rfq.exchangeRates || {};
  let exchangeRateHTML = '';
  if (exchangeRates.USD || exchangeRates.JPY) {
    exchangeRateHTML = '<br><strong>Exchange Rates:</strong> ';
    if (exchangeRates.USD) exchangeRateHTML += `USD 1.00 = PHP ${exchangeRates.USD} `;
    if (exchangeRates.JPY) exchangeRateHTML += `JPY 1.00 = PHP ${exchangeRates.JPY}`;
  }

  const hasMixedCurrency = respondedSuppliers.some(s => s.currency && s.currency !== 'PHP');
  const signatories = rfq.signatories || [];
  let signatoryBoxesHTML = '';
  if (signatories.length > 0) {
    let headerRow = '<tr style="height: 18px;">';
    signatories.forEach(sig => {
      headerRow += `
        <td style="border: 1px solid #000; padding: 1px 3px; text-align: center; width: ${Math.floor(100 / signatories.length)}%; font-size: 7pt; font-weight: bold; line-height: 1.1; vertical-align: middle; height: 18px;">
          ${sig.header || ''}
        </td>
      `;
    });
    headerRow += '</tr>';
    
    let signatureRow = '<tr>';
    signatories.forEach(sig => {
      signatureRow += `
        <td style="border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 3px; text-align: center; vertical-align: bottom; height: 80px; font-size: 7pt; font-weight: bold; line-height: 1.1;">
          ${sig.title || ''}
        </td>
      `;
    });
    signatureRow += '</tr>';
    
    signatoryBoxesHTML = headerRow + signatureRow;
  }

  const uploadedQuotes = rfq.uploadedQuotes || {};
  let quotesHTML = '';
  
  if (Object.keys(uploadedQuotes).length > 0) {
    quotesHTML = '<div style="margin-top: 30px; page-break-before: always;"><h2 style="font-size: 14pt; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 8px;">Uploaded Quotations</h2>';
    
    respondedSuppliers.forEach(supplier => {
      if (uploadedQuotes[supplier.id] && uploadedQuotes[supplier.id].length > 0) {
        quotesHTML += `
          <div style="margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; background: #f9f9f9;">
            <h3 style="font-size: 11pt; font-weight: bold; margin-bottom: 10px; color: #003a8c;">${supplier.name}</h3>
            <ul style="list-style: none; padding: 0; margin: 0;">
        `;
        
        uploadedQuotes[supplier.id].forEach(file => {
          quotesHTML += `
            <li style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #ddd;">
              <strong style="font-size: 9pt;">ðŸ“„ ${file.fileName}</strong>
              <br><span style="font-size: 7pt; color: #666;">Uploaded: ${new Date(file.uploadedAt).toLocaleString()}</span>
              <br><a href="${file.fileUrl}" target="_blank" style="font-size: 8pt; color: #0066cc;">View Document</a>
            </li>
          `;
        });
        
        quotesHTML += '</ul></div>';
      }
    });
    
    quotesHTML += '</div>';
  }

  let html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Price Comparison - ${rfq.rfqNumber}</title>
  <style>
    @page { size: A4 landscape; margin: 15mm; }
    body { font-family: Arial, sans-serif; font-size: 9pt; margin: 0; padding: 15px; }
    .header-section { display: table; width: 100%; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
    .header-left { display: table-cell; width: 50%; vertical-align: top; padding-right: 20px; }
    .header-right { display: table-cell; width: 50%; vertical-align: top; }
    .header-left h1 { margin: 0 0 5px 0; font-size: 12pt; font-weight: bold; }
    .header-left p { margin: 2px 0; font-size: 7pt; }
    .header-left h2 { margin: 8px 0 5px 0; font-size: 10pt; font-weight: bold; }
    .signatory-table { width: 100%; border-collapse: collapse; }
    .signatory-table td { height: 60px; }
    table.data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 8pt; }
    table.data-table th, table.data-table td { border: 1px solid #000; padding: 5px; text-align: left; vertical-align: top; }
    table.data-table th { background-color: #f0f0f0; font-weight: bold; text-align: center; font-size: 8pt; }
    .supplier-col { background-color: #e8f4f8; font-weight: bold; }
    .currency-col { text-align: center; font-weight: bold; }
    .php-price-col { background-color: #fff3cd; text-align: right; font-weight: bold; }
    .footer { margin-top: 15px; font-size: 7pt; text-align: center; color: #666; }
  </style>
</head>
<body>
  <div class="header-section">
    <div class="header-left">
      <h1>ADMIN. DEPT.- PURCHASING DIVISION</h1>
      <p>Telephone Number: (6347) 935-6986, local 206, 220, 232, 222</p>
      <p>Email: fbm.purchasing@minebeamitsumi.com.ph</p>
      <h2>QUOTATION COMPARISON</h2>
      <p><strong>RFQ REFERENCE NO.: ${rfq.rfqNumber}</strong>${exchangeRateHTML}</p>
    </div>
    <div class="header-right">
      ${signatories.length > 0 ? `
        <table class="signatory-table">
          ${signatoryBoxesHTML}
        </table>
      ` : ''}
    </div>
  </div>
  
  <table class="data-table">
    <thead>
      <tr>
        <th style="width: 3%;">NO.</th>
        <th style="width: ${hasMixedCurrency ? '15%' : '18%'};">ITEM DESCRIPTION</th>
        <th style="width: ${hasMixedCurrency ? '10%' : '12%'};">SUPPLIER</th>
        <th style="width: 5%;">UOM</th>
        <th style="width: 5%;">CURRENCY</th>
        <th style="width: ${hasMixedCurrency ? '8%' : '10%'};">COST/PRICE</th>
        ${hasMixedCurrency ? '<th style="width: 9%;">PHP COST/PRICE</th>' : ''}
        <th style="width: ${hasMixedCurrency ? '9%' : '10%'};">LEAD TIME</th>
        <th style="width: ${hasMixedCurrency ? '13%' : '15%'};">PAYMENT TERM</th>
        <th style="width: ${hasMixedCurrency ? '18%' : '22%'};">REMARKS</th>
      </tr>
    </thead>
    <tbody>`;

  rfq.items.forEach((item, idx) => {
    const itemName = item.itemName;
    const partNo = item.partNo;
    const itemDesc = partNo ? `${itemName}<br>(${partNo})` : itemName;
    
    let firstSupplierRow = true;
    let validSupplierCount = 0;

    respondedSuppliers.forEach(supplier => {
      const priceInput = document.querySelector(`input[data-item="${idx}"][data-supplier="${supplier.id}"]`);
      const price = priceInput ? priceInput.value.trim() : '';
      if (price) validSupplierCount++;
    });

    respondedSuppliers.forEach(supplier => {
      const uomInput = document.querySelector(`input[data-uom="${idx}"][data-supplier="${supplier.id}"]`);
      const priceInput = document.querySelector(`input[data-item="${idx}"][data-supplier="${supplier.id}"]`);
      const leadTimeInput = document.querySelector(`input[data-leadtime="${idx}"][data-supplier="${supplier.id}"]`);
      const paymentInput = document.querySelector(`input[data-payment="${idx}"][data-supplier="${supplier.id}"]`);
      const remarksInput = document.querySelector(`input[data-remarks="${idx}"][data-supplier="${supplier.id}"]`);
      const phpPriceDisplay = document.getElementById(`php-price-${idx}-${supplier.id}`);
      
      const uom = uomInput ? uomInput.value : 'PCS';
      const price = priceInput ? priceInput.value.trim() : '';
      const leadTime = leadTimeInput ? leadTimeInput.value : '';
      const paymentTerm = paymentInput ? paymentInput.value : '';
      const remarks = remarksInput ? remarksInput.value : '';
      const currency = supplier.currency || 'PHP';
      const phpPrice = phpPriceDisplay ? phpPriceDisplay.textContent : '-';
      
      if (price) {
        html += `<tr>`;
        
        if (firstSupplierRow) {
          html += `
            <td rowspan="${validSupplierCount}" style="text-align: center;">${idx + 1}</td>
            <td rowspan="${validSupplierCount}">${itemDesc}</td>
          `;
          firstSupplierRow = false;
        }
        
        html += `
          <td class="supplier-col">${supplier.name}</td>
          <td style="text-align: center;">${uom}</td>
          <td class="currency-col">${currency}</td>
          <td style="text-align: right;">${price}</td>
          ${hasMixedCurrency ? `<td class="php-price-col">${phpPrice}</td>` : ''}
          <td>${leadTime || '-'}</td>
          <td>${paymentTerm || '-'}</td>
          <td>${remarks || '-'}</td>
        </tr>`;
      }
    });
  });

  html += `</tbody>
  </table>
  ${quotesHTML}
  <div class="footer">
    <p>Generated on ${new Date().toLocaleString()} | Â© 2025 TrackWatch RFQ Dashboard Pro</p>
  </div>
</body>
</html>`;

  const previewWindow = window.open('', '_blank', 'width=1200,height=800');
  previewWindow.document.write(html);
  previewWindow.document.close();
};

window.downloadPriceComparison = async () => {
  const previewContent = document.createElement('div');
  previewContent.id = 'download-preview-content';
  previewContent.style.position = 'absolute';
  previewContent.style.left = '-9999px';
  previewContent.style.width = '1200px';
  document.body.appendChild(previewContent);

  const rfqId = document.getElementById('comparisonRFQId').value;
  const rfq = allRFQs.find(r => r.id === rfqId);
  if (!rfq) return;

  const respondedSuppliers = (rfq.suppliers || []).filter(s => 
    s.status === 'Responded' || s.status === 'Quote Received'
  );

  const exchangeRates = rfq.exchangeRates || {};
  let exchangeRateHTML = '';
  if (exchangeRates.USD || exchangeRates.JPY) {
    exchangeRateHTML = '<br><strong>Exchange Rates:</strong> ';
    if (exchangeRates.USD) exchangeRateHTML += `USD 1.00 = PHP ${exchangeRates.USD} `;
    if (exchangeRates.JPY) exchangeRateHTML += `JPY 1.00 = PHP ${exchangeRates.JPY}`;
  }

  const hasMixedCurrency = respondedSuppliers.some(s => s.currency && s.currency !== 'PHP');
  const signatories = rfq.signatories || [];
  let signatoryBoxesHTML = '';
  
  if (signatories.length > 0) {
    let headerRow = '<tr style="height: 18px;">';
    signatories.forEach(sig => {
      headerRow += `
        <td style="border: 1px solid #000; padding: 1px 3px; text-align: center; width: ${Math.floor(100 / signatories.length)}%; font-size: 7pt; font-weight: bold; line-height: 1.1; vertical-align: middle; height: 18px;">
          ${sig.header || ''}
        </td>
      `;
    });
    headerRow += '</tr>';
    
    let signatureRow = '<tr>';
    signatories.forEach(sig => {
      signatureRow += `
        <td style="border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 3px; text-align: center; vertical-align: bottom; height: 80px; font-size: 7pt; font-weight: bold; line-height: 1.1;">
          ${sig.title || ''}
        </td>
      `;
    });
    signatureRow += '</tr>';
    
    signatoryBoxesHTML = headerRow + signatureRow;
  }

  let tableBodyHTML = '';

  rfq.items.forEach((item, idx) => {
    const itemName = item.itemName;
    const partNo = item.partNo;
    const itemDesc = partNo ? `${itemName}<br>(${partNo})` : itemName;
    
    let firstSupplierRow = true;
    let validSupplierCount = 0;

    respondedSuppliers.forEach(supplier => {
      const priceInput = document.querySelector(`input[data-item="${idx}"][data-supplier="${supplier.id}"]`);
      const price = priceInput ? priceInput.value.trim() : '';
      if (price) validSupplierCount++;
    });

    respondedSuppliers.forEach(supplier => {
      const uomInput = document.querySelector(`input[data-uom="${idx}"][data-supplier="${supplier.id}"]`);
      const priceInput = document.querySelector(`input[data-item="${idx}"][data-supplier="${supplier.id}"]`);
      const leadTimeInput = document.querySelector(`input[data-leadtime="${idx}"][data-supplier="${supplier.id}"]`);
      const paymentInput = document.querySelector(`input[data-payment="${idx}"][data-supplier="${supplier.id}"]`);
      const remarksInput = document.querySelector(`input[data-remarks="${idx}"][data-supplier="${supplier.id}"]`);
      const phpPriceDisplay = document.getElementById(`php-price-${idx}-${supplier.id}`);
      
      const uom = uomInput ? uomInput.value : 'PCS';
      const price = priceInput ? priceInput.value.trim() : '';
      const leadTime = leadTimeInput ? leadTimeInput.value : '';
      const paymentTerm = paymentInput ? paymentInput.value : '';
      const remarks = remarksInput ? remarksInput.value : '';
      const currency = supplier.currency || 'PHP';
      const phpPrice = phpPriceDisplay ? phpPriceDisplay.textContent : '-';
      
      if (price) {
        tableBodyHTML += `<tr>`;
        
        if (firstSupplierRow) {
          tableBodyHTML += `
            <td rowspan="${validSupplierCount}" style="text-align: center;">${idx + 1}</td>
            <td rowspan="${validSupplierCount}">${itemDesc}</td>
          `;
          firstSupplierRow = false;
        }
        
        tableBodyHTML += `
          <td class="supplier-col">${supplier.name}</td>
          <td style="text-align: center;">${uom}</td>
          <td class="currency-col">${currency}</td>
          <td style="text-align: right;">${price}</td>
          ${hasMixedCurrency ? `<td class="php-price-col">${phpPrice}</td>` : ''}
          <td>${leadTime || '-'}</td>
          <td>${paymentTerm || '-'}</td>
          <td>${remarks || '-'}</td>
        </tr>`;
      }
    });
  });

  const uploadedQuotes = rfq.uploadedQuotes || {};
  let quotesHTML = '';
  
  if (Object.keys(uploadedQuotes).length > 0) {
    quotesHTML = '<div style="margin-top: 30px;"><h2 style="font-size: 14pt; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 8px;">Uploaded Quotations</h2>';
    
    respondedSuppliers.forEach(supplier => {
      if (uploadedQuotes[supplier.id] && uploadedQuotes[supplier.id].length > 0) {
        quotesHTML += `
          <div style="margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; background: #f9f9f9;">
            <h3 style="font-size: 11pt; font-weight: bold; margin-bottom: 10px; color: #003a8c;">${supplier.name}</h3>
            <ul style="list-style: none; padding: 0; margin: 0;">
        `;
        
        uploadedQuotes[supplier.id].forEach(file => {
          quotesHTML += `
            <li style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #ddd;">
              <strong style="font-size: 9pt;">ðŸ“„ ${file.fileName}</strong>
              <br><span style="font-size: 7pt; color: #666;">Uploaded: ${new Date(file.uploadedAt).toLocaleString()}</span>
              <br><a href="${file.fileUrl}" target="_blank" style="font-size: 8pt; color: #0066cc;">View Document</a>
            </li>
          `;
        });
        
        quotesHTML += '</ul></div>';
      }
    });
    
    quotesHTML += '</div>';
  }
const fullHTML = `
    <style>
      @page { size: A4 landscape; margin: 15mm; }
      body { font-family: Arial, sans-serif; font-size: 9pt; margin: 0; padding: 15px; }
      .header-section { display: table; width: 100%; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
      .header-left { display: table-cell; width: 50%; vertical-align: top; padding-right: 20px; }
      .header-right { display: table-cell; width: 50%; vertical-align: top; }
      .header-left h1 { margin: 0 0 5px 0; font-size: 12pt; font-weight: bold; }
      .header-left p { margin: 2px 0; font-size: 7pt; }
      .header-left h2 { margin: 8px 0 5px 0; font-size: 10pt; font-weight: bold; }
      .signatory-table { width: 100%; border-collapse: collapse; }
      .signatory-table td { height: 60px; }
      table.data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 8pt; }
      table.data-table th, table.data-table td { border: 1px solid #000; padding: 5px; text-align: left; vertical-align: top; }
      table.data-table th { background-color: #f0f0f0; font-weight: bold; text-align: center; font-size: 8pt; }
      .supplier-col { background-color: #e8f4f8; font-weight: bold; }
      .currency-col { text-align: center; font-weight: bold; }
      .php-price-col { background-color: #fff3cd; text-align: right; font-weight: bold; }
      .footer { margin-top: 15px; font-size: 7pt; text-align: center; color: #666; }
    </style>
    <div class="header-section">
      <div class="header-left">
        <h1>ADMIN. DEPT.- PURCHASING DIVISION</h1>
        <p>Telephone Number: (6347) 935-6986, local 206, 220, 232, 222</p>
        <p>Email: fbm.purchasing@minebeamitsumi.com.ph</p>
        <h2>QUOTATION COMPARISON</h2>
        <p><strong>RFQ REFERENCE NO.: ${rfq.rfqNumber}</strong>${exchangeRateHTML}</p>
      </div>
      <div class="header-right">
        ${signatories.length > 0 ? `
          <table class="signatory-table">
            ${signatoryBoxesHTML}
          </table>
        ` : ''}
      </div>
    </div>
    
    <table class="data-table">
      <thead>
        <tr>
          <th style="width: 3%;">NO.</th>
          <th style="width: ${hasMixedCurrency ? '15%' : '18%'};">ITEM DESCRIPTION</th>
          <th style="width: ${hasMixedCurrency ? '10%' : '12%'};">SUPPLIER</th>
          <th style="width: 5%;">UOM</th>
          <th style="width: 5%;">CURRENCY</th>
          <th style="width: ${hasMixedCurrency ? '8%' : '10%'};">COST/PRICE</th>
          ${hasMixedCurrency ? '<th style="width: 9%;">PHP COST/PRICE</th>' : ''}
          <th style="width: ${hasMixedCurrency ? '9%' : '10%'};">LEAD TIME</th>
          <th style="width: ${hasMixedCurrency ? '13%' : '15%'};">PAYMENT TERM</th>
          <th style="width: ${hasMixedCurrency ? '18%' : '22%'};">REMARKS</th>
        </tr>
      </thead>
      <tbody>
        ${tableBodyHTML}
      </tbody>
    </table>
    ${quotesHTML}
    <div class="footer">
      <p>Generated on ${new Date().toLocaleString()} |  Â© 2025 TrackWatch RFQ Dashboard Pro | by Jefferson Molina</p>
    </div>
  `;

  previewContent.innerHTML = fullHTML;

  try {
    const canvas = await html2canvas(previewContent, {
      scale: 2,
      useCORS: true,
      logging: false,
      width: 1200
    });

    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('l', 'mm', 'a4');
    
    const imgWidth = 297;
    const pageHeight = 210;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    pdf.save(`Price_Comparison_${rfq.rfqNumber}_${new Date().toISOString().split('T')[0]}.pdf`);
    
  } catch (error) {
    console.error('PDF generation error:', error);
    alert('Error generating PDF: ' + error.message);
  } finally {
    document.body.removeChild(previewContent);
  }
};

</script>

<style>
:root {
  --bg-primary: #f5f7fa;
  --bg-secondary: #ffffff;
  --bg-tertiary: #f9fafb;
  --text-primary: #1a202c;
  --text-secondary: #718096;
  --border-color: #e2e8f0;
  --accent-blue: #3182ce;
  --accent-blue-hover: #2c5282;
  --accent-green: #38a169;
  --accent-green-hover: #2f855a;
  --accent-red: #e53e3e;
  --accent-red-hover: #c53030;
  --shadow: rgba(0,0,0,0.08);
  --shadow-heavy: rgba(0,0,0,0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
}

header { 
  background: var(--bg-secondary);
  padding: 20px 40px;
  box-shadow: 0 1px 3px var(--shadow);
  border-bottom: 1px solid var(--border-color);
}

header h1 {
  font-size: 24px;
  font-weight: 600;
  color: var(--text-primary);
}

footer { 
  background: var(--bg-secondary);
  text-align: center;
  font-size: 13px;
  color: var(--text-secondary);
  padding: 16px;
  border-top: 1px solid var(--border-color);
  margin-top: auto;
}

.layout { display: flex; min-height: calc(100vh - 120px); }

aside { 
  width: 260px;
  background: var(--bg-secondary);
  padding: 24px 16px;
  border-right: 1px solid var(--border-color);
}

aside h2 { 
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  margin-bottom: 16px;
  padding: 0 12px;
}

aside button { 
  width: 100%;
  padding: 12px 16px;
  border: none;
  border-radius: 6px;
  background: transparent;
  color: var(--text-primary);
  font-weight: 500;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
  margin-bottom: 4px;
}

aside button:hover { 
  background: var(--bg-tertiary);
}

aside button.active { 
  background: var(--accent-blue);
  color: white;
}

main { 
  flex: 1;
  padding: 32px;
  overflow-y: auto;
}

.card { 
  background: var(--bg-secondary);
  border-radius: 12px;
  box-shadow: 0 1px 3px var(--shadow);
  padding: 32px;
  border: 1px solid var(--border-color);
}

.card h1 { 
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border-color);
}

.form-grid { 
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.form-group { 
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label { 
  font-weight: 600;
  font-size: 13px;
  color: var(--text-primary);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.form-row { 
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

table { 
  width: 100%;
  border-collapse: collapse;
  margin-top: 24px;
  font-size: 14px;
}

thead th { 
  text-align: left;
  font-weight: 700;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  padding: 12px 16px;
  background: var(--bg-tertiary);
  border-bottom: 2px solid var(--border-color);
}

tbody td { 
  padding: 14px 16px;
  border-bottom: 1px solid var(--border-color);
  color: var(--text-primary);
}

tbody tr:hover { 
  background: var(--bg-tertiary);
}

.input-field { 
  width: 100%;
  padding: 10px 14px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  background: var(--bg-secondary);
  font-size: 14px;
  color: var(--text-primary);
  transition: all 0.2s;
  font-family: inherit;
}

.input-field:focus { 
  outline: none;
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
}

.input-field.compact {
  padding: 6px 10px;
  font-size: 13px;
}

select.input-field {
  cursor: pointer;
}

textarea.input-field { 
  resize: vertical;
  min-height: 80px;
}

.remove-btn { 
  background: var(--accent-red);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
}

.remove-btn:hover { 
  background: var(--accent-red-hover);
}

.action-buttons { 
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 24px;
  flex-wrap: wrap;
}

.add-btn, .save-btn, .action-btn { 
  border: none;
  border-radius: 6px;
  padding: 10px 20px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.add-btn { 
  background: var(--accent-green);
  color: white;
}

.add-btn:hover { 
  background: var(--accent-green-hover);
}

.save-btn { 
  background: var(--accent-blue);
  color: white;
}

.save-btn:hover { 
  background: var(--accent-blue-hover);
}

.action-btn { 
  background: var(--accent-blue);
  color: white;
  padding: 8px 16px;
  font-size: 13px;
}

.action-btn:hover { 
  background: var(--accent-blue-hover);
}

.action-btn.primary {
  background: var(--accent-green);
}

.action-btn.primary:hover {
  background: var(--accent-green-hover);
}

.action-btn.secondary { 
  background: white;
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.action-btn.secondary:hover { 
  background: var(--bg-tertiary);
  border-color: var(--accent-blue);
}

.section { 
  display: none;
}

.section.active { 
  display: block;
}

.status-badge { 
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  display: inline-block;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.status-open { 
  background: #c6f6d5;
  color: #22543d;
}

.status-closed { 
  background: #fed7d7;
  color: #742a2a;
}

.status-pending-response { 
  background: #feebc8;
  color: #7c2d12;
}

.status-responded { 
  background: #bee3f8;
  color: #2c5282;
}

.status-quote-received { 
  background: #c6f6d5;
  color: #22543d;
}

.status-declined { 
  background: #fed7d7;
  color: #742a2a;
}

.status-follow-up-required { 
  background: #feebc8;
  color: #7c2d12;
}

.currency-badge {
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 700;
  display: inline-block;
  letter-spacing: 0.5px;
}

.currency-PHP {
  background: #bee3f8;
  color: #2c5282;
}

.currency-USD {
  background: #c6f6d5;
  color: #22543d;
}

.currency-JPY {
  background: #feebc8;
  color: #7c2d12;
}

.rfq-link, .supplier-link { 
  color: var(--accent-blue);
  text-decoration: none;
  font-weight: 600;
  transition: all 0.2s;
}

.rfq-link:hover, .supplier-link:hover { 
  text-decoration: underline;
  color: var(--accent-blue-hover);
}

.modal { 
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
  overflow-y: auto;
}

.modal-content { 
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 32px;
  max-width: 1000px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  position: relative;
  margin: auto;
}

.modal-header { 
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border-color);
}

.modal-header h2 { 
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.close-btn { 
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  width: 36px;
  height: 36px;
  cursor: pointer;
  font-size: 24px;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  line-height: 1;
}

.close-btn:hover { 
  background: var(--accent-red);
  color: white;
  border-color: var(--accent-red);
}

.detail-grid { 
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 28px;
  padding: 24px;
  background: var(--bg-tertiary);
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.detail-item { 
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.detail-label { 
  font-size: 11px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.detail-value { 
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.modal-section { 
  margin-top: 28px;
}

.modal-section h3 { 
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  color: var(--text-primary);
  padding-bottom: 8px;
  border-bottom: 2px solid var(--border-color);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.supplier-check-item { 
  padding: 16px;
  background: var(--bg-tertiary);
  border-radius: 8px;
  margin-bottom: 12px;
  border: 1px solid var(--border-color);
  transition: all 0.2s;
}

.supplier-check-item:hover { 
  border-color: var(--accent-blue);
}

.supplier-check-item label { 
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
}

.supplier-check-item input[type="checkbox"] { 
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.supplier-details { 
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border-color);
}

.status-actions { 
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.status-btn { 
  padding: 10px 20px;
  border: 2px solid;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s;
  background: white;
}

.status-btn.open { 
  border-color: #38a169;
  color: #38a169;
}

.status-btn.open:hover {
  background: #38a169;
  color: white;
}

.status-btn.closed { 
  border-color: #e53e3e;
  color: #e53e3e;
}

.status-btn.closed:hover {
  background: #e53e3e;
  color: white;
}

.exchange-rate-box {
  background: #fffbeb;
  border: 2px solid #f59e0b;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 24px;
}

.exchange-rate-box h3 {
  margin: 0 0 16px 0;
  font-size: 14px;
  font-weight: 700;
  color: #92400e;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.row-number {
  text-align: center;
  font-weight: 700;
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.item-desc {
  font-size: 13px;
}

.item-desc strong {
  font-weight: 600;
  color: var(--text-primary);
}

.part-no {
  font-size: 11px;
  color: var(--text-secondary);
  font-weight: 400;
}

.supplier-col {
  background: #e6f7ff;
  font-weight: 600;
  color: #003a8c;
}

.uom-col, .currency-col, .price-col {
  text-align: center;
}

.php-price-col {
  text-align: right;
  font-weight: 600;
  background: #fff9e6;
}

.php-price-display {
  font-weight: 600;
  color: #2c5282;
}

.signatory-item {
  padding: 20px;
  background: var(--bg-tertiary);
  border-radius: 8px;
  margin-bottom: 16px;
  border: 1px solid var(--border-color);
}

.signatory-item h4 {
  color: var(--text-primary);
  font-weight: 600;
}

@media (max-width: 768px) {
  .layout { flex-direction: column; }
  aside { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); }
  .card { padding: 20px; }
  .form-grid { grid-template-columns: 1fr; }
  main { padding: 20px; }
}
</style>
</head>
<body>

<header>
  <h1>TrackWatch RFQ Dashboard Pro</h1>
</header>

<div class="layout">
  <aside>
    <h2>Navigation</h2>
    <button class="active" data-target="createRFQSection" onclick="showSection('createRFQSection')">Create RFQ</button>
    <button data-target="rfqMonitoringSection" onclick="showSection('rfqMonitoringSection')">RFQ Monitoring</button>
    <button data-target="supplierSection" onclick="showSection('supplierSection')">Supplier Management</button>
  </aside>

  <main>
    <!-- Create RFQ Section -->
    <div id="createRFQSection" class="section active">
      <div class="card">
        <h1>Create New RFQ</h1>
        <div class="form-grid">
          <div class="form-group">
            <label for="rfqNumber">RFQ Number <span style="color:var(--accent-red)">*</span></label>
            <input id="rfqNumber" type="text" placeholder="e.g., RFQ-2025-001" class="input-field" />
          </div>
          <div class="form-group">
            <label for="rfqDescription">Description</label>
            <input id="rfqDescription" type="text" placeholder="Brief description of RFQ" class="input-field" />
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>ITEM NAME</th>
              <th>PART NO.</th>
              <th>QUANTITY</th>
              <th>MAKER</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="rfqBody"></tbody>
        </table>
        <div class="action-buttons">
          <button class="add-btn" onclick="addRow()">Add Item</button>
          <button class="save-btn" onclick="saveRFQ()">Save RFQ</button>
        </div>
      </div>
    </div>

    <!-- RFQ Monitoring Section -->
    <div id="rfqMonitoringSection" class="section">
      <div class="card">
        <h1>RFQ Monitoring Dashboard</h1>
        <table>
          <thead>
            <tr>
              <th>RFQ NUMBER</th>
              <th>DESCRIPTION</th>
              <th>CREATED DATE</th>
              <th>STATUS</th>
              <th>SUPPLIERS</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="rfqMonitoringBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Supplier List Section -->
    <div id="supplierSection" class="section">
      <div class="card">
        <h1>Supplier Management</h1>
        <div class="form-grid">
          <div class="form-group">
            <label for="supplierName">Supplier Name <span style="color:var(--accent-red)">*</span></label>
            <input id="supplierName" type="text" placeholder="Company Name" class="input-field" />
          </div>
          <div class="form-group">
            <label for="supplierContact">Contact Person</label>
            <input id="supplierContact" type="text" placeholder="Contact Name" class="input-field" />
          </div>
          <div class="form-group">
            <label for="supplierEmail">Email <span style="color:var(--accent-red)">*</span></label>
            <input id="supplierEmail" type="email" placeholder="email@company.com" class="input-field" />
          </div>
          <div class="form-group">
            <label for="supplierAddress">Address</label>
            <input id="supplierAddress" type="text" placeholder="Company Address" class="input-field" />
          </div>
          <div class="form-group">
            <label for="supplierPaymentTerm">Payment Term</label>
            <input id="supplierPaymentTerm" type="text" placeholder="e.g., 30 days, Net 45" class="input-field" />
          </div>
          <div class="form-group">
            <label for="supplierCurrency">Currency <span style="color:var(--accent-red)">*</span></label>
            <select id="supplierCurrency" class="input-field">
              <option value="PHP">PHP - Philippine Peso</option>
              <option value="USD">USD - US Dollar</option>
              <option value="JPY">JPY - Japanese Yen</option>
            </select>
          </div>

<div class="form-group">
  <label for="supplierCourier">Mode of Shipment / Courier</label>
  <select id="supplierCourier" class="input-field">
    <option value="">-- Select Courier --</option>
    <option value="DSV Logistics">DSV Logistics</option>
    <option value="DHL Express">DHL Express</option>
    <option value="J&T Express">J&T Express</option>
    <option value="OCS Courier">OCS Courier</option>
    <option value="2GO Express">2GO Express</option>
    <option value="FedEx Courier">FedEx Courier</option>
  </select>
</div>


        </div>
        <input type="hidden" id="currentEditSupplierId" value="">
        <div class="action-buttons">
          <button class="save-btn" onclick="addSupplier()">Add Supplier</button>
        </div>
        
        <div style="margin-top: 30px;">
          <h3 style="color: var(--text-primary); margin-bottom: 15px; font-weight: 700;">Active Suppliers</h3>
          <table>
<thead>
  <tr>
    <th>COMPANY NAME</th>
    <th>CONTACT PERSON</th>
    <th>EMAIL</th>
    <th>ADDRESS</th>
    <th>PAYMENT TERM</th>
    <th>CURRENCY</th>
    <th>COURIER</th>
  </tr>
</thead>
            <tbody id="supplierListBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- RFQ Details Modal -->
<div id="rfqDetailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>RFQ Details</h2>
      <button class="close-btn" onclick="closeRFQDetailsModal()">Ã—</button>
    </div>
    
    <input type="hidden" id="currentRFQId">
    
    <div class="detail-grid">
      <div class="detail-item">
        <span class="detail-label">RFQ Number</span>
        <span class="detail-value" id="detailRFQNumber">-</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Created Date</span>
        <span class="detail-value" id="detailRFQDate">-</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Status</span>
        <span class="detail-value" id="detailRFQStatus">-</span>
      </div>
      <div class="detail-item" style="grid-column: 1 / -1;">
        <span class="detail-label">Description</span>
        <span class="detail-value" id="detailRFQDescription">-</span>
      </div>
    </div>

    <div class="status-actions">
      <button class="status-btn open" onclick="updateRFQStatus('Open')">Mark as Open</button>
      <button class="status-btn closed" onclick="updateRFQStatus('Closed')">Mark as Closed</button>
    </div>

    <div class="modal-section">
      <h3>Items in this RFQ</h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>ITEM NAME</th>
            <th>PART NO.</th>
            <th>QTY</th>
            <th>MAKER</th>
          </tr>
        </thead>
<tbody id="rfqItemsBody"></tbody>
      </table>
    </div>

    <div class="modal-section">
      <h3>Suppliers Assigned</h3>
      <table>
        <thead>
          <tr>
            <th>SUPPLIER</th>
            <th>SENT DATE</th>
            <th>STATUS</th>
            <th>RESPONSE DATE</th>
            <th>NOTES</th>
          </tr>
        </thead>
        <tbody id="rfqSuppliersBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Supplier Management Modal -->
<div id="supplierManagementModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Manage Suppliers for RFQ: <span id="supplierRFQNumber"></span></h2>
      <button class="close-btn" onclick="closeSupplierManagementModal()">Ã—</button>
    </div>
    
    <input type="hidden" id="currentRFQIdSupplier">
    
    <div class="modal-section">
      <p style="color: var(--text-secondary); margin-bottom: 15px;">Select suppliers to send this RFQ to and track their responses:</p>
      <div id="supplierChecklist"></div>
    </div>

    <div class="action-buttons">
      <button class="save-btn" onclick="saveSupplierAssignments()">Save Assignments</button>
    </div>
  </div>
</div>

<!-- Price Comparison Modal -->
<div id="priceComparisonModal" class="modal">
  <div class="modal-content" style="max-width: 1400px;">
    <div class="modal-header">
      <h2>Price Comparison - RFQ: <span id="comparisonRFQNumber"></span></h2>
      <button class="close-btn" onclick="closePriceComparisonModal()">Ã—</button>
    </div>
    
    <input type="hidden" id="comparisonRFQId">
    
    <div id="exchangeRateSection" class="exchange-rate-box" style="display:none;">
      <h3>Exchange Rates (Required for Mixed Currency Quotes)</h3>
      <div class="form-row">
        <div class="form-group">
          <label>USD to PHP Rate:</label>
          <input type="text" id="exchangeRateUSD" class="input-field" placeholder="e.g., 57.09" onchange="recalculateAllPHPPrices()">
        </div>
        <div class="form-group">
          <label>JPY to PHP Rate:</label>
          <input type="text" id="exchangeRateJPY" class="input-field" placeholder="e.g., 0.3885" onchange="recalculateAllPHPPrices()">
        </div>
      </div>
    </div>
    
    <div class="modal-section">
      <p style="color: var(--text-secondary); margin-bottom: 15px;">
        Edit the prices below, upload PDF quotations for each supplier, and generate a comparison report.
      </p>
      
      <div style="overflow-x: auto;">
        <table>
          <thead id="priceComparisonHead"></thead>
          <tbody id="priceComparisonBody"></tbody>
        </table>
      </div>
    </div>

    <div class="action-buttons">
      <button class="action-btn secondary" onclick="openSignatoryModal()">Configure Signatories</button>
      <button class="action-btn secondary" onclick="generatePreview()">Preview Report</button>
      <button class="action-btn primary" onclick="downloadPriceComparison()">Download Price Comparison</button>
      <button class="save-btn" onclick="savePriceComparisonData()">Save Data</button>
    </div>
  </div>
</div>

<!-- Signatory Configuration Modal -->
<div id="signatoryModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2>Configure Signatories</h2>
      <button class="close-btn" onclick="closeSignatoryModal()">Ã—</button>
    </div>
    
    <div class="modal-section">
      <p style="color: var(--text-secondary); margin-bottom: 15px;">
        Add signatory boxes that will appear in the generated report.
      </p>
      
      <div class="form-group" style="margin-bottom: 20px;">
        <label>Number of Signatories:</label>
        <input type="number" id="signatoryCount" class="input-field" min="1" max="10" value="5" onchange="generateSignatoryFields()">
      </div>
      
      <div id="signatoryFieldsContainer"></div>
    </div>

    <div class="action-buttons">
      <button class="save-btn" onclick="saveSignatories()">Save Signatories</button>
    </div>
  </div>
</div>

<footer>Â© 2025 TrackWatch RFQ Dashboard Pro. All rights reserved. by Jefferson Molina.</footer>

</body>

</html>
